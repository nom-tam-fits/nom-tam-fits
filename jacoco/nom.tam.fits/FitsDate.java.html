<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FitsDate.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nom.tam FITS library</a> &gt; <a href="index.source.html" class="el_package">nom.tam.fits</a> &gt; <span class="el_source">FitsDate.java</span></div><h1>FitsDate.java</h1><pre class="source lang-java linenums">package nom.tam.fits;

/*
 * #%L
 * nom.tam FITS library
 * %%
 * Copyright (C) 1996 - 2021 nom-tam-fits
 * %%
 * This is free and unencumbered software released into the public domain.
 * 
 * Anyone is free to copy, modify, publish, use, compile, sell, or
 * distribute this software, either in source code form or as a compiled
 * binary, for any purpose, commercial or non-commercial, and by any
 * means.
 * 
 * In jurisdictions that recognize copyright laws, the author or authors
 * of this software dedicate any and all copyright interest in the
 * software to the public domain. We make this dedication for the benefit
 * of the public at large and to the detriment of our heirs and
 * successors. We intend this dedication to be an overt act of
 * relinquishment in perpetuity of all present and future rights to this
 * software under copyright law.
 * 
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR
 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 * #L%
 */

import java.text.DecimalFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.TimeZone;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;

/**
 * Fits date object parsed from the different type of date combinations
 */
public class FitsDate implements Comparable&lt;FitsDate&gt; {

    /**
     * logger to log to.
     */
<span class="fc" id="L53">    private static final Logger LOG = Logger.getLogger(FitsDate.class.getName());</span>

    private static final int FIRST_THREE_CHARACTER_VALUE = 100;

    private static final int FIRST_TWO_CHARACTER_VALUE = 10;

    private static final int FITS_DATE_STRING_SIZE = 23;

<span class="fc" id="L61">    private static final TimeZone GMT = TimeZone.getTimeZone(&quot;GMT&quot;);</span>

    private static final int NEW_FORMAT_DAY_OF_MONTH_GROUP = 4;

    private static final int NEW_FORMAT_HOUR_GROUP = 6;

    private static final int NEW_FORMAT_MILLISECOND_GROUP = 10;

    private static final int NEW_FORMAT_MINUTE_GROUP = 7;

    private static final int NEW_FORMAT_MONTH_GROUP = 3;

    private static final int NEW_FORMAT_SECOND_GROUP = 8;

    private static final int NEW_FORMAT_YEAR_GROUP = 2;

<span class="fc" id="L77">    private static final Pattern NORMAL_REGEX = Pattern</span>
<span class="fc" id="L78">            .compile(&quot;\\s*(([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9]))(T([0-9][0-9]):([0-9][0-9]):([0-9][0-9])(\\.([0-9]+))?)?\\s*&quot;);</span>

    private static final int OLD_FORMAT_DAY_OF_MONTH_GROUP = 1;

    private static final int OLD_FORMAT_MONTH_GROUP = 2;

    private static final int OLD_FORMAT_YEAR_GROUP = 3;

<span class="fc" id="L86">    private static final Pattern OLD_REGEX = Pattern.compile(&quot;\\s*([0-9][0-9])/([0-9][0-9])/([0-9][0-9])\\s*&quot;);</span>

    private static final int YEAR_OFFSET = 1900;
    
    private static final int NB_DIGITS_MILLIS = 3;
    
    private static final int POW_TEN = 10;

    /**
     * @return the current date in FITS date format
     */
    public static String getFitsDateString() {
<span class="fc" id="L98">        return getFitsDateString(new Date(), true);</span>
    }

    /**
     * @return a created FITS format date string Java Date object.
     * @param epoch
     *            The epoch to be converted to FITS format.
     */
    public static String getFitsDateString(Date epoch) {
<span class="fc" id="L107">        return getFitsDateString(epoch, true);</span>
    }

    /**
     * @return a created FITS format date string. Note that the date is not
     *         rounded.
     * @param epoch
     *            The epoch to be converted to FITS format.
     * @param timeOfDay
     *            Should time of day information be included?
     */
    public static String getFitsDateString(Date epoch, boolean timeOfDay) {
<span class="fc" id="L119">        Calendar cal = Calendar.getInstance(FitsDate.GMT);</span>
<span class="fc" id="L120">        cal.setTime(epoch);</span>
<span class="fc" id="L121">        StringBuilder fitsDate = new StringBuilder();</span>
<span class="fc" id="L122">        DecimalFormat df = new DecimalFormat(&quot;0000&quot;);</span>
<span class="fc" id="L123">        fitsDate.append(df.format(cal.get(Calendar.YEAR)));</span>
<span class="fc" id="L124">        fitsDate.append(&quot;-&quot;);</span>
<span class="fc" id="L125">        df = new DecimalFormat(&quot;00&quot;);</span>

<span class="fc" id="L127">        fitsDate.append(df.format(cal.get(Calendar.MONTH) + 1));</span>
<span class="fc" id="L128">        fitsDate.append(&quot;-&quot;);</span>
<span class="fc" id="L129">        fitsDate.append(df.format(cal.get(Calendar.DAY_OF_MONTH)));</span>

<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if (timeOfDay) {</span>
<span class="fc" id="L132">            fitsDate.append(&quot;T&quot;);</span>
<span class="fc" id="L133">            fitsDate.append(df.format(cal.get(Calendar.HOUR_OF_DAY)));</span>
<span class="fc" id="L134">            fitsDate.append(&quot;:&quot;);</span>
<span class="fc" id="L135">            fitsDate.append(df.format(cal.get(Calendar.MINUTE)));</span>
<span class="fc" id="L136">            fitsDate.append(&quot;:&quot;);</span>
<span class="fc" id="L137">            fitsDate.append(df.format(cal.get(Calendar.SECOND)));</span>
<span class="fc" id="L138">            fitsDate.append(&quot;.&quot;);</span>
<span class="fc" id="L139">            df = new DecimalFormat(&quot;000&quot;);</span>
<span class="fc" id="L140">            fitsDate.append(df.format(cal.get(Calendar.MILLISECOND)));</span>
        }
<span class="fc" id="L142">        return fitsDate.toString();</span>
    }

<span class="fc" id="L145">    private Date date = null;</span>

<span class="fc" id="L147">    private int hour = -1;</span>

<span class="fc" id="L149">    private int mday = -1;</span>

<span class="fc" id="L151">    private int millisecond = -1;</span>

<span class="fc" id="L153">    private int minute = -1;</span>

<span class="fc" id="L155">    private int month = -1;</span>

<span class="fc" id="L157">    private int second = -1;</span>

<span class="fc" id="L159">    private int year = -1;</span>

    /**
     * Convert a FITS date string to a Java &lt;CODE&gt;Date&lt;/CODE&gt; object.
     * 
     * @param dStr
     *            the FITS date
     * @throws FitsException
     *             if &lt;CODE&gt;dStr&lt;/CODE&gt; does not contain a valid FITS date.
     */
<span class="fc" id="L169">    public FitsDate(String dStr) throws FitsException {</span>
        // if the date string is null, we are done
<span class="pc bpc" id="L171" title="1 of 4 branches missed.">        if (dStr == null || dStr.isEmpty()) {</span>
<span class="fc" id="L172">            return;</span>
        }
<span class="fc" id="L174">        Matcher match = FitsDate.NORMAL_REGEX.matcher(dStr);</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">        if (match.matches()) {</span>
<span class="fc" id="L176">            this.year = getInt(match, FitsDate.NEW_FORMAT_YEAR_GROUP);</span>
<span class="fc" id="L177">            this.month = getInt(match, FitsDate.NEW_FORMAT_MONTH_GROUP);</span>
<span class="fc" id="L178">            this.mday = getInt(match, FitsDate.NEW_FORMAT_DAY_OF_MONTH_GROUP);</span>
<span class="fc" id="L179">            this.hour = getInt(match, FitsDate.NEW_FORMAT_HOUR_GROUP);</span>
<span class="fc" id="L180">            this.minute = getInt(match, FitsDate.NEW_FORMAT_MINUTE_GROUP);</span>
<span class="fc" id="L181">            this.second = getInt(match, FitsDate.NEW_FORMAT_SECOND_GROUP);</span>
<span class="fc" id="L182">            this.millisecond = getMilliseconds(match, FitsDate.NEW_FORMAT_MILLISECOND_GROUP);</span>
        } else {
<span class="fc" id="L184">            match = FitsDate.OLD_REGEX.matcher(dStr);</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">            if (match.matches()) {</span>
<span class="fc" id="L186">                this.year = getInt(match, FitsDate.OLD_FORMAT_YEAR_GROUP) + FitsDate.YEAR_OFFSET;</span>
<span class="fc" id="L187">                this.month = getInt(match, FitsDate.OLD_FORMAT_MONTH_GROUP);</span>
<span class="fc" id="L188">                this.mday = getInt(match, FitsDate.OLD_FORMAT_DAY_OF_MONTH_GROUP);</span>
            } else {
<span class="fc bfc" id="L190" title="All 2 branches covered.">                if (dStr.trim().isEmpty()) {</span>
<span class="fc" id="L191">                    return;</span>
                }
<span class="fc" id="L193">                throw new FitsException(&quot;Bad FITS date string \&quot;&quot; + dStr + '&quot;');</span>
            }
        }
<span class="fc" id="L196">    }</span>

    private static int getInt(Matcher match, int groupIndex) {
<span class="fc" id="L199">        String value = match.group(groupIndex);</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">        if (value != null) {</span>
<span class="fc" id="L201">            return Integer.parseInt(value);</span>
        }
<span class="fc" id="L203">        return -1;</span>
    }

    private static int getMilliseconds(Matcher match, int groupIndex) {
<span class="fc" id="L207">        String value = match.group(groupIndex);</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">        if (value != null) {</span>
<span class="fc" id="L209">            value = String.format(&quot;%-3s&quot;, value).replace(' ', '0');</span>
<span class="fc" id="L210">            int num = Integer.parseInt(value);</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">            if (value.length() &gt; NB_DIGITS_MILLIS) {</span>
<span class="fc" id="L212">                num = (int) Math.round(num / Math.pow(POW_TEN, value.length() - NB_DIGITS_MILLIS));</span>
            }
<span class="fc" id="L214">            return num;</span>
        }
<span class="fc" id="L216">        return -1;</span>
    }

    /**
     * Get a Java Date object corresponding to this FITS date.
     * 
     * @return The Java Date object.
     */
    @SuppressFBWarnings(value = &quot;EI_EXPOSE_REP&quot;, justification = &quot;intended exposure of mutable data&quot;)
    public Date toDate() {
<span class="pc bpc" id="L226" title="2 of 4 branches missed.">        if (this.date == null &amp;&amp; this.year != -1) {</span>
<span class="fc" id="L227">            Calendar cal = Calendar.getInstance(FitsDate.GMT);</span>

<span class="fc" id="L229">            cal.set(Calendar.YEAR, this.year);</span>
<span class="fc" id="L230">            cal.set(Calendar.MONTH, this.month - 1);</span>
<span class="fc" id="L231">            cal.set(Calendar.DAY_OF_MONTH, this.mday);</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">            if (FitsDate.LOG.isLoggable(Level.FINEST)) {</span>
<span class="fc" id="L233">                FitsDate.LOG.log(Level.FINEST, &quot;At this point:&quot; + cal.getTime());</span>
            }

<span class="fc bfc" id="L236" title="All 2 branches covered.">            if (this.hour == -1) {</span>

<span class="fc" id="L238">                cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="fc" id="L239">                cal.set(Calendar.MINUTE, 0);</span>
<span class="fc" id="L240">                cal.set(Calendar.SECOND, 0);</span>
<span class="fc" id="L241">                cal.set(Calendar.MILLISECOND, 0);</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">                if (FitsDate.LOG.isLoggable(Level.FINEST)) {</span>
<span class="fc" id="L243">                    FitsDate.LOG.log(Level.FINEST, &quot;2At this point:&quot; + cal.getTime());</span>
                }
            } else {
<span class="fc" id="L246">                cal.set(Calendar.HOUR_OF_DAY, this.hour);</span>
<span class="fc" id="L247">                cal.set(Calendar.MINUTE, this.minute);</span>
<span class="fc" id="L248">                cal.set(Calendar.SECOND, this.second);</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">                if (this.millisecond == -1) {</span>
<span class="fc" id="L250">                    cal.set(Calendar.MILLISECOND, 0);</span>
                } else {
<span class="fc" id="L252">                    cal.set(Calendar.MILLISECOND, this.millisecond);</span>
                }
<span class="fc bfc" id="L254" title="All 2 branches covered.">                if (FitsDate.LOG.isLoggable(Level.FINEST)) {</span>
<span class="fc" id="L255">                    FitsDate.LOG.log(Level.FINEST, &quot;3At this point:&quot; + cal.getTime());</span>
                }
            }
<span class="fc" id="L258">            this.date = cal.getTime();</span>
        }
<span class="fc bfc" id="L260" title="All 2 branches covered.">        if (FitsDate.LOG.isLoggable(Level.FINEST)) {</span>
<span class="fc" id="L261">            FitsDate.LOG.log(Level.FINEST, &quot;  date:&quot; + this.date);</span>
<span class="fc" id="L262">            FitsDate.LOG.log(Level.FINEST, &quot;  year:&quot; + this.year);</span>
<span class="fc" id="L263">            FitsDate.LOG.log(Level.FINEST, &quot;  month:&quot; + this.month);</span>
<span class="fc" id="L264">            FitsDate.LOG.log(Level.FINEST, &quot;  mday:&quot; + this.mday);</span>
<span class="fc" id="L265">            FitsDate.LOG.log(Level.FINEST, &quot;  hour:&quot; + this.hour);</span>
        }
<span class="fc" id="L267">        return this.date;</span>
    }

    @Override
    public String toString() {
<span class="fc bfc" id="L272" title="All 2 branches covered.">        if (this.year == -1) {</span>
<span class="fc" id="L273">            return &quot;&quot;;</span>
        }
<span class="fc" id="L275">        StringBuilder buf = new StringBuilder(FitsDate.FITS_DATE_STRING_SIZE);</span>
<span class="fc" id="L276">        buf.append(this.year);</span>
<span class="fc" id="L277">        buf.append('-');</span>
<span class="fc" id="L278">        appendTwoDigitValue(buf, this.month);</span>
<span class="fc" id="L279">        buf.append('-');</span>
<span class="fc" id="L280">        appendTwoDigitValue(buf, mday);</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">        if (this.hour != -1) {</span>
<span class="fc" id="L282">            buf.append('T');</span>
<span class="fc" id="L283">            appendTwoDigitValue(buf, this.hour);</span>
<span class="fc" id="L284">            buf.append(':');</span>
<span class="fc" id="L285">            appendTwoDigitValue(buf, this.minute);</span>
<span class="fc" id="L286">            buf.append(':');</span>
<span class="fc" id="L287">            appendTwoDigitValue(buf, this.second);</span>
<span class="fc bfc" id="L288" title="All 2 branches covered.">            if (this.millisecond != -1) {</span>
<span class="fc" id="L289">                buf.append('.');</span>
<span class="fc" id="L290">                appendThreeDigitValue(buf, this.millisecond);</span>
            }
        }
<span class="fc" id="L293">        return buf.toString();</span>
    }

    @Override
    public boolean equals(Object o) {
<span class="fc bfc" id="L298" title="All 2 branches covered.">        if (o == this) {</span>
<span class="fc" id="L299">            return true;</span>
        }
<span class="fc bfc" id="L301" title="All 2 branches covered.">        if (!(o instanceof FitsDate)) {</span>
<span class="fc" id="L302">            return false;</span>
        }

<span class="fc" id="L305">        FitsDate fitsDate = (FitsDate) o;</span>
<span class="pc bpc" id="L306" title="6 of 14 branches missed.">        return hour == fitsDate.hour &amp;&amp; mday == fitsDate.mday &amp;&amp; millisecond == fitsDate.millisecond</span>
                &amp;&amp; minute == fitsDate.minute &amp;&amp; month == fitsDate.month &amp;&amp; second == fitsDate.second &amp;&amp; year == fitsDate.year;
    }


    @Override
    public int hashCode() {
<span class="fc" id="L313">        final int prime = 31;</span>
<span class="fc" id="L314">        int result = prime * hour;</span>
<span class="fc" id="L315">        result = prime * result + mday;</span>
<span class="fc" id="L316">        result = prime * result + millisecond;</span>
<span class="fc" id="L317">        result = prime * result + minute;</span>
<span class="fc" id="L318">        result = prime * result + month;</span>
<span class="fc" id="L319">        result = prime * result + second;</span>
<span class="fc" id="L320">        result = prime * result + year;</span>

<span class="fc" id="L322">        return result;</span>
    }

    @Override
    public int compareTo(FitsDate fitsDate) {
<span class="fc" id="L327">        int result = Integer.compare(year, fitsDate.year);</span>
<span class="fc bfc" id="L328" title="All 2 branches covered.">        if (result == 0) {</span>
<span class="fc" id="L329">            result = Integer.compare(month, fitsDate.month);</span>
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">            if (result == 0) {</span>
<span class="fc" id="L331">                result = Integer.compare(mday, fitsDate.mday);</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">                if (result == 0) {</span>
<span class="fc" id="L333">                    result = Integer.compare(hour, fitsDate.hour);</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">                    if (result == 0) {</span>
<span class="fc" id="L335">                        result = Integer.compare(minute, fitsDate.minute);</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">                        if (result == 0) {</span>
<span class="fc" id="L337">                            result = Integer.compare(second, fitsDate.second);</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">                            if (result == 0) {</span>
<span class="fc" id="L339">                                result = Integer.compare(millisecond, fitsDate.millisecond);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L346">        return result;</span>
    }

    private void appendThreeDigitValue(StringBuilder buf, int value) {
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">        if (value &lt; FitsDate.FIRST_THREE_CHARACTER_VALUE) {</span>
<span class="fc" id="L351">            buf.append('0');</span>
        }
<span class="fc" id="L353">        appendTwoDigitValue(buf, value);</span>
<span class="fc" id="L354">    }</span>

    private void appendTwoDigitValue(StringBuilder buf, int value) {
<span class="fc bfc" id="L357" title="All 2 branches covered.">        if (value &lt; FitsDate.FIRST_TWO_CHARACTER_VALUE) {</span>
<span class="fc" id="L358">            buf.append('0');</span>
        }
<span class="fc" id="L360">        buf.append(value);</span>
<span class="fc" id="L361">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>